# 调参与排障手册

本手册用于解决真实落地中的高频问题：

- 同一物体重复检测；
- 同一物体跨类别反复跳；
- 手关键点抖动、左右手互跳；
- ROI 过小或方向不稳定；
- 手快动时关键点滞后；
- 遮挡下接触状态断续。

---

## 1. 快速排障总流程

1. 开启 `--debug`，先看叠加信息（含 `ms pose/full/roi/hand/post` 阶段耗时）；
2. 看 `obj raw/dedup/temporal` 计数关系；
3. 看 `hands raw` 与 `lr` 是否稳定；
4. 看 ROI 数量是否符合预期（单手通常 1 个）；
5. 再按问题类型调参。

---

## 2. 常见问题与参数策略

### 2.1 同一物体重复检测

表现：

- 画面里出现多个同类别框，明显对应同一目标。

优先调参：

1. `--obj-dedup-iou`：提高一点（如 `0.45 -> 0.55`）；
2. `--obj-dedup-center-ratio`：略增（如 `0.35 -> 0.45`）；
3. 保持 `--obj-dedup` 开启。

若是“单手却出现双 ROI”：

1. 调大 `--hand-roi-cross-side-merge-ratio`；
2. 调大 `--hand-side-merge-ratio`（手稳定器侧）。

### 2.2 同一物体被识别成不同类别并同时显示

表现：

- 大框一个类别，小框另一个类别，交替或并存。

优先调参：

1. 保持 `--obj-conflict-suppress` 开启；
2. 调高 `--obj-conflict-overlap`（更强嵌套才触发冲突）；
3. 调低 `--obj-conflict-score-gap`（更偏向高分优先）；
4. 开启 `--obj-temporal` 并提高 `--obj-temporal-class-decay`（如 `0.9 -> 0.95`）。

### 2.3 手关键点抖动、左右手互跳

优先调参：

1. `--hand-stabilize` 确认开启；
2. `--hand-smooth-alpha` 适当降低可更稳（但延迟增加）；
3. `--hand-smooth-fast-alpha` 提升快动跟随；
4. `--hand-smooth-motion-scale` 适度减小（让快动更快切换高 alpha）；
5. `--hand-hold-frames` 调大 1~2 帧抗短遮挡。

### 2.4 ROI 过小或不稳定

优先调参：

1. `--hand-roi-min-size` 增大（如 `96 -> 128`）；
2. `--hand-roi-min-size-ratio` 增大（如 `0.12 -> 0.15`）；
3. `--hand-roi-shrink-floor` 提高（如 `0.9 -> 0.95`）防骤缩；
4. `--hand-roi-size-smooth` 适中（过高跟手，过低易滞后）。

### 2.5 ROI 外扩方向不一致（时而向内时而向外）

优先调参：

1. `--hand-roi-direction-smooth` 增大一点；
2. `--hand-roi-forward-shift` 与 `--hand-roi-context-scale` 联调（前向外扩主控）；
3. `--hand-roi-inward-scale` 与 `--hand-roi-inward-shift` 控制内向补偿。

建议目标：

- “向外扩展明显多于向内扩展”，但保留少量向内防漏。

### 2.6 手快动时关键点滞后明显

优先调参：

1. 降低 `--imgsz`；
2. 提升 `--hand-smooth-fast-alpha`；
3. 减小 `--hand-smooth-motion-scale`；
4. 必要时降低 `--hand-smooth-alpha` 的稳态权重。

### 2.7 遮挡时接触状态断续

优先调参：

1. `--obj-temporal-hold-frames` 增大（如 `3 -> 5`）；
2. `--contact-expand` 与 `--contact-dist` 适当增大；
3. `--contact-min-points` 不宜过高；
4. 保持 ROI 检测开启（`--hand-roi-det`）。

### 2.8 预览 FPS 低（个位数）或明显卡顿

先看 `--debug` 面板中的阶段耗时：

- `pose` 高：优先降 `--imgsz`，必要时降低 `--pred-max-det`；
- `full` 高：全图分割负载高，先降 `--imgsz`，再调 `--pred-max-det`；
- `roi` 高：ROI 过多或 ROI 分割开销大，优先确认 ROI 数量是否异常，再尝试 `--pred-batch 2~4`；
- 绘制卡顿：使用 `--no-draw-mask-edges` 切到 bbox-only 预览。

常用降载顺序：

1. `--imgsz 640 -> 512 -> 448`
2. `--pred-max-det 300 -> 120 -> 80`
3. `--no-draw-mask-edges`
4. `--pred-batch 2`（多 ROI 场景）

### 2.9 有明显物体轮廓，但没有任何类别标签

先确认 unknown 回退已开启：

1. `--unknown-roi-fallback`
2. 保持 `--draw-mask-edges` 开启，便于观察 unknown 轮廓

若 unknown 太少（漏出）：

1. 调低 `--unknown-min-area-ratio`（如 `0.012 -> 0.008`）
2. 调大 `--unknown-max-hand-dist-ratio`（如 `0.58 -> 0.8`）
3. 适当调高 `--unknown-max-hand-overlap-ratio`（遮挡重时很有用）

若 unknown 太多（误报）：

1. 调高 `--unknown-min-area-ratio`
2. 调低 `--unknown-max-area-ratio`
3. 调低 `--unknown-max-hand-dist-ratio`，约束必须靠近手部
4. 调低 `--unknown-max-hand-overlap-ratio`，避免手区大面积轮廓
5. 调高 `--unknown-min-fill-ratio`、`--unknown-min-solidity`
6. 调低 `--unknown-max-aspect-ratio`，抑制墙缝/衣物边缘等细长轮廓

### 2.10 全图已检出大物体，ROI 又检出局部重复/冲突

先确认以下开关与阈值：

1. `--roi-partial-suppress`
2. `--roi-partial-overlap`
3. `--roi-partial-area-ratio`
4. `--roi-object-max-area-ratio`

推荐方向：

1. 重复仍多：提高 `--roi-partial-overlap` 或降低 `--roi-partial-area-ratio`
2. ROI 经常检出大块局部：降低 `--roi-object-max-area-ratio`
3. ROI 真正小目标被误杀：适当降低 `--roi-partial-overlap` 或提高 `--roi-partial-area-ratio`

---

## 3. 推荐参数预设

### 3.1 实时优先（低延迟）

```text
imgsz=512
pred_max_det=120
draw_mask_edges=False
hand_smooth_alpha=0.65
hand_smooth_fast_alpha=0.92
hand_smooth_motion_scale=0.10
obj_temporal=True
obj_temporal_hold_frames=2
```

特点：跟手更快，但稳态略弱。

### 3.2 稳定优先（鲁棒）

```text
imgsz=640
hand_smooth_alpha=0.50
hand_hold_frames=3
obj_dedup_iou=0.50
obj_conflict_overlap=0.80
obj_temporal_hold_frames=4
obj_temporal_class_decay=0.95
```

特点：抖动和跳类更少，但响应稍慢。

---

## 4. 调参顺序建议（避免混乱）

1. 固定模型与数据，不要同时改多件事；
2. 先稳“类别”：
   - `det-whitelist` + `obj-conflict-*`
3. 再稳“轨迹”：
   - `obj-dedup-*` + `obj-temporal-*`
4. 再稳“手”：
   - `hand-*stabilize*`
5. 最后调“接触”：
   - `contact-*`

每轮最多调整 2~3 个参数，并记录结果。

---

## 5. 现场部署建议

1. 固定摄像头视角，避免大角度晃动；
2. 保证主目标区域光照稳定；
3. 使用与训练数据分布接近的背景与物体摆放；
4. 对常见遮挡姿态做定向补数据后再训练；
5. 上线前用真实场景视频跑回放压测，避免只看单帧效果。
